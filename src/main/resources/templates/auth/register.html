<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Регистрация - Events Platform</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h2 class="card-title">Создать аккаунт</h2>
                            <p class="text-muted">Присоединяйтесь к нашему сообществу</p>
                        </div>

                        <!-- Error messages -->
                        <div th:if="${error}" class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span th:text="${error}">Ошибка регистрации</span>
                        </div>

                        <form th:action="@{/api/v1/public/user}" method="post" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">Имя</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName"
                                           required>
                                    <div class="invalid-feedback">Пожалуйста, введите ваше имя</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Фамилия</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName"
                                           required>
                                    <div class="invalid-feedback">Пожалуйста, введите вашу фамилию</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="username" class="form-label">Имя пользователя *</label>
                                <input type="text" class="form-control" id="username" name="username"
                                       required minlength="3" maxlength="24">
                                <div class="invalid-feedback">Имя пользователя должно быть от 3 до 24 символов</div>
                                <div class="form-text">Это имя будет отображаться другим пользователям</div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email адрес *</label>
                                <input type="email" class="form-control" id="email" name="email"
                                       required>
                                <div class="invalid-feedback">Пожалуйста, введите корректный email</div>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Пароль *</label>
                                <input type="password" class="form-control" id="password" name="password"
                                       required minlength="6">
                                <div class="invalid-feedback">Пароль должен содержать минимум 6 символов</div>
                                <div class="password-strength mt-2">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Сложность пароля: слабый</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Подтверждение пароля *</label>
                                <input type="password" class="form-control" id="confirmPassword"
                                       required>
                                <div class="invalid-feedback">Пароли не совпадают</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label" for="terms">
                                        Я принимаю <a href="/terms">условия использования</a> и
                                        <a href="/privacy">политику конфиденциальности</a>
                                    </label>
                                    <div class="invalid-feedback">Вы должны принять условия использования</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newsletter">
                                    <label class="form-check-label" for="newsletter">
                                        Подписаться на рассылку о новых мероприятиях
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 py-2 mb-3">
                                <i class="fas fa-user-plus me-2"></i>Зарегистрироваться
                            </button>

                            <div class="text-center">
                                <p class="mb-0">Уже есть аккаунт? <a th:href="@{/login}">Войти</a></p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Password strength indicator
            const passwordInput = document.getElementById('password');
            const progressBar = document.querySelector('.progress-bar');
            const strengthText = document.querySelector('.password-strength small');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;

                if (password.length >= 6) strength += 25;
                if (password.length >= 8) strength += 25;
                if (/[A-Z]/.test(password)) strength += 25;
                if (/[0-9]/.test(password)) strength += 25;

                progressBar.style.width = strength + '%';

                if (strength < 50) {
                    progressBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Сложность пароля: слабый';
                } else if (strength < 75) {
                    progressBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Сложность пароля: средний';
                } else {
                    progressBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Сложность пароля: сильный';
                }
            });

            // Password confirmation validation
            const confirmPasswordInput = document.getElementById('confirmPassword');
            confirmPasswordInput.addEventListener('input', function() {
                if (this.value !== passwordInput.value) {
                    this.setCustomValidity('Пароли не совпадают');
                } else {
                    this.setCustomValidity('');
                }
            });

            // Form submission handling
            const form = document.querySelector('form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!form.checkValidity()) {
                    e.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Регистрация...';
                submitButton.disabled = true;

                try {
                    const formData = {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        username: document.getElementById('username').value,
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value
                    };

                    const response = await fetch('/api/v1/public/user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        window.location.href = '/login?registered=true';
                    } else {
                        const error = await response.text();
                        throw new Error(error);
                    }
                } catch (error) {
                    alert('Ошибка регистрации: ' + error.message);
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            });
        });
    </script>
</div>
</body>
</html>