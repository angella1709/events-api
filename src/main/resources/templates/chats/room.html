<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title th:text="${event.name} + ' - Чат'">Чат мероприятия</title>
    <style>
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 80vh;
        }
        .messages-container {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .messages-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 500px;
        }
        .message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            max-width: 70%;
        }
        .message.own {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.other {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
        }
        .message-header {
            font-size: 0.8rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .tasks-section, .checklist-section {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item, .checklist-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item:hover, .checklist-item:hover {
            background: #f8f9fa;
        }
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .template-modal {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 th:text="${event.name}">Название мероприятия</h1>
                <p class="text-muted mb-0" th:text="'Участников: ' + ${event.participants.size()}">Участников: 0</p>
            </div>
            <a th:href="@{/chats}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Назад к чатам
            </a>
        </div>

        <div class="chat-container">
            <!-- Основной чат -->
            <div class="messages-container">
                <div class="messages-list" id="messagesList">
                    <div class="loading" id="loadingMessages">
                        <i class="fas fa-spinner fa-spin me-2"></i>Загрузка сообщений...
                    </div>
                </div>

                <div class="message-input">
                    <form id="messageForm">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="input-group mb-2">
                            <textarea id="messageInput" class="form-control"
                                      placeholder="Введите сообщение..."
                                      rows="2" required maxlength="1000"></textarea>
                            <button type="submit" class="btn btn-primary" id="sendMessage">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('imageUpload').click()">
                                    <i class="fas fa-image"></i> Фото
                                </button>
                                <span id="imagePreview" class="ms-2"></span>
                            </div>
                            <small class="text-muted"><span id="messageCounter">0</span>/1000</small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Боковая панель с задачами и списком -->
            <div class="side-panel">
                <!-- Задачи -->
                <div class="tasks-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks text-primary me-2"></i>Задачи
                        </h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="filter-buttons">
                        <button class="btn btn-sm btn-outline-primary active filter-btn" data-type="task" data-filter="all">
                            Все
                        </button>
                        <button class="btn btn-sm btn-outline-primary filter-btn" data-type="task" data-filter="my">
                            Мои
                        </button>
                        <button class="btn btn-sm btn-outline-primary filter-btn" data-type="task" data-filter="active">
                            Активные
                        </button>
                    </div>

                    <div id="tasksList">
                        <div class="loading">Загрузка задач...</div>
                    </div>
                </div>

                <!-- Список вещей -->
                <div class="checklist-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-list-check text-success me-2"></i>Список вещей
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-success me-1" data-bs-toggle="modal" data-bs-target="#addChecklistModal">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#templatesModal">
                                <i class="fas fa-clipboard-list"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filter-buttons">
                        <button class="btn btn-sm btn-outline-success active filter-btn" data-type="checklist" data-filter="all">
                            Все
                        </button>
                        <button class="btn btn-sm btn-outline-success filter-btn" data-type="checklist" data-filter="my">
                            Мои
                        </button>
                        <button class="btn btn-sm btn-outline-success filter-btn" data-type="checklist" data-filter="active">
                            Активные
                        </button>
                    </div>

                    <div id="checklistList">
                        <div class="loading">Загрузка списка...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <!-- Модальное окно добавления задачи -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить задачу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label class="form-label">Описание задачи *</label>
                            <textarea class="form-control" name="description" required
                                      placeholder="Опишите задачу..." maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Назначить пользователю</label>
                            <select class="form-select" name="assignedUserId">
                                <option value="">Не назначено</option>
                                <option th:each="user : ${participants}"
                                        th:value="${user.id}"
                                        th:text="${user.username}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления элемента списка -->
    <div class="modal fade" id="addChecklistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить в список</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checklistForm">
                        <div class="mb-3">
                            <label class="form-label">Название *</label>
                            <input type="text" class="form-control" name="name" required
                                   placeholder="Название элемента">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description"
                                      placeholder="Описание элемента" maxlength="200"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Назначить пользователю</label>
                            <select class="form-select" name="assignedUserId">
                                <option value="">Не назначено</option>
                                <option th:each="user : ${participants}"
                                        th:value="${user.id}"
                                        th:text="${user.username}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success" onclick="addChecklistItem()">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора шаблона -->
    <div class="modal fade" id="templatesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Выберите шаблон</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body template-modal">
                    <div id="templatesList">
                        <div class="loading">Загрузка шаблонов...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script th:inline="javascript">
        // Глобальные переменные
        const eventId = /*[[${event.id}]]*/ null;
        const currentUserId = /*[[${currentUser.id}]]*/ null;
        const currentUsername = /*[[${currentUser.username}]]*/ 'user';
        let stompClient = null;
        let selectedImages = [];

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadMessages();
            loadTasks();
            loadChecklist();
            loadTemplates();
            setupEventListeners();
        });

        // WebSocket соединение
        function initializeWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function(frame) {
                    console.log('Connected: ' + frame);

                    // Подписка на сообщения чата
                    stompClient.subscribe('/topic/chat/' + eventId, function(message) {
                        const chatMessage = JSON.parse(message.body);
                        addMessageToChat(chatMessage);
                    });

                    // Подписка на обновления задач
                    stompClient.subscribe('/topic/tasks/' + eventId, function(message) {
                        const tasks = JSON.parse(message.body);
                        updateTasksList(tasks);
                    });

                    // Подписка на обновления списка
                    stompClient.subscribe('/topic/checklist/' + eventId, function(message) {
                        const checklist = JSON.parse(message.body);
                        updateChecklistList(checklist);
                    });
                }, function(error) {
                    console.error('WebSocket connection error:', error);
                    console.log('Continuing without WebSocket support');
                });
            } catch (error) {
                console.error('WebSocket initialization error:', error);
            }
        }

        // Загрузка сообщений
        async function loadMessages() {
            try {
                const response = await fetch('/api/v1/chat/' + eventId);
                if (!response.ok) throw new Error('Failed to load messages');

                const data = await response.json();

                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = '';

                if (data.data && data.data.length > 0) {
                    data.data.forEach(message => addMessageToChat(message));
                } else {
                    messagesList.innerHTML = '<div class="empty-state">Нет сообщений</div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML =
                    '<div class="error">Ошибка загрузки сообщений</div>';
            }
        }

        // Добавление сообщения в чат
        function addMessageToChat(message) {
            const messagesList = document.getElementById('messagesList');
            const isOwn = message.author === currentUsername;

            // Убираем сообщение о загрузке если оно есть
            const loadingElement = document.getElementById('loadingMessages');
            if (loadingElement) {
                loadingElement.remove();
            }

            // Проверяем, нет ли уже пустого состояния
            if (messagesList.innerHTML.includes('empty-state')) {
                messagesList.innerHTML = '';
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwn ? 'own' : 'other'}`;

            let imagesHtml = '';
            if (message.images && message.images.length > 0) {
                imagesHtml = message.images.map(img =>
                    `<img src="${img.url}" class="image-preview" alt="Изображение" style="max-width: 200px; max-height: 150px;">`
                ).join('');
            }

            messageElement.innerHTML = `
                <div class="message-header">
                    <strong>${message.author}</strong>
                    <span class="ms-2">${new Date(message.createdAt).toLocaleString()}</span>
                    ${message.edited ? '<small class="ms-2">(ред.)</small>' : ''}
                </div>
                <div class="message-content">${message.content}</div>
                ${imagesHtml}
            `;

            messagesList.appendChild(messageElement);
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        // Отправка сообщения
        document.getElementById('messageForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content && selectedImages.length === 0) {
                alert('Введите сообщение или выберите изображение');
                return;
            }

            const sendButton = document.getElementById('sendMessage');
            const originalHtml = sendButton.innerHTML;

            try {
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;

                const response = await fetch('/api/v1/chat?eventId=' + eventId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    const newMessage = await response.json();
                    addMessageToChat(newMessage);
                    messageInput.value = '';
                    document.getElementById('messageCounter').textContent = '0';

                    // Очищаем превью изображений
                    document.getElementById('imagePreview').innerHTML = '';
                    selectedImages = [];
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Ошибка при отправке сообщения: ' + error.message);
            } finally {
                sendButton.innerHTML = originalHtml;
                sendButton.disabled = false;
            }
        });

        // Загрузка и предпросмотр изображений
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('imagePreview');

            preview.innerHTML = '';
            selectedImages = [];

            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Файл слишком большой. Максимальный размер: 10MB');
                        return;
                    }

                    selectedImages.push(file);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview me-2';
                        img.style.maxWidth = '50px';
                        img.style.maxHeight = '50px';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Пожалуйста, выберите только изображения');
                }
            });
        });

        // Счетчик символов
        document.getElementById('messageInput').addEventListener('input', function() {
            document.getElementById('messageCounter').textContent = this.value.length;
        });

        // Задачи
        async function loadTasks() {
            try {
                const response = await fetch('/api/v1/task/' + eventId);
                if (!response.ok) throw new Error('Failed to load tasks');

                const tasks = await response.json();
                updateTasksList(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksList').innerHTML =
                    '<div class="error">Ошибка загрузки задач</div>';
            }
        }

        function updateTasksList(tasks) {
            const tasksList = document.getElementById('tasksList');

            if (!tasks || tasks.length === 0) {
                tasksList.innerHTML = '<div class="empty-state">Нет задач</div>';
                return;
            }

            tasksList.innerHTML = '';

            tasks.forEach(task => {
                const isCreator = task.creator === currentUsername;
                const isAssigned = task.assignedUserId === currentUserId;
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskElement.setAttribute('data-creator', task.creator);
                taskElement.setAttribute('data-assigned-user', task.assignedUserId || '');
                taskElement.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-medium">${task.description}</div>
                        <small class="text-muted">
                            Создал: ${task.creator}
                            ${task.assignedUser ? '→ ' + task.assignedUser : ''}
                        </small>
                    </div>
                    <div class="item-actions">
                        <input type="checkbox" class="form-check-input task-complete"
                               ${task.completed ? 'checked' : ''}
                               data-task-id="${task.id}">
                        ${isCreator ? `
                        <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="${task.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                tasksList.appendChild(taskElement);
            });
        }

        // Список вещей
        async function loadChecklist() {
            try {
                const response = await fetch('/api/v1/checklist/' + eventId);
                if (!response.ok) throw new Error('Failed to load checklist');

                const checklist = await response.json();
                updateChecklistList(checklist);
            } catch (error) {
                console.error('Error loading checklist:', error);
                document.getElementById('checklistList').innerHTML =
                    '<div class="error">Ошибка загрузки списка</div>';
            }
        }

        function updateChecklistList(checklist) {
            const checklistList = document.getElementById('checklistList');

            if (!checklist || checklist.length === 0) {
                checklistList.innerHTML = '<div class="empty-state">Список пуст</div>';
                return;
            }

            checklistList.innerHTML = '';

            checklist.forEach(item => {
                const isCreator = item.createdBy === currentUsername;
                const isAssigned = item.assignedUser === currentUsername;
                const itemElement = document.createElement('div');
                itemElement.className = `checklist-item ${item.completed ? 'completed' : ''}`;
                itemElement.setAttribute('data-creator', item.createdBy);
                itemElement.setAttribute('data-assigned-user', item.assignedUser || '');
                itemElement.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-medium">${item.name} <span class="badge bg-secondary">${item.quantity}x</span></div>
                        ${item.description ? `<small class="text-muted">${item.description}</small><br>` : ''}
                        <small class="text-muted">
                            Добавил: ${item.createdBy}
                            ${item.assignedUser ? '→ ' + item.assignedUser : ''}
                        </small>
                    </div>
                    <div class="item-actions">
                        <input type="checkbox" class="form-check-input item-complete"
                               ${item.completed ? 'checked' : ''}
                               data-item-id="${item.id}">
                        ${isCreator ? `
                        <button class="btn btn-sm btn-outline-danger delete-item" data-item-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                checklistList.appendChild(itemElement);
            });
        }

        // Загрузка шаблонов
        async function loadTemplates() {
            try {
                const response = await fetch('/api/v1/public/templates');
                if (!response.ok) throw new Error('Failed to load templates');

                const templates = await response.json();
                displayTemplates(templates);
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML =
                    '<div class="error">Ошибка загрузки шаблонов</div>';
            }
        }

        function displayTemplates(templates) {
            const templatesList = document.getElementById('templatesList');

            if (!templates || templates.length === 0) {
                templatesList.innerHTML = '<div class="empty-state">Нет доступных шаблонов</div>';
                return;
            }

            templatesList.innerHTML = '';

            templates.forEach(template => {
                const templateElement = document.createElement('div');
                templateElement.className = 'card mb-3';
                templateElement.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">${template.name}</h6>
                        <p class="card-text text-muted">${template.description || ''}</p>
                        <small class="text-muted">Элементов: ${template.items ? template.items.length : 0}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success apply-template" data-template-id="${template.id}">
                                Применить шаблон
                            </button>
                        </div>
                    </div>
                `;
                templatesList.appendChild(templateElement);
            });
        }

        // Обработчики событий
        function setupEventListeners() {
            // Фильтрация
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const filter = this.getAttribute('data-filter');
                    filterItems(type, filter);
                });
            });

            // Завершение задач
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-complete')) {
                    toggleTaskCompletion(e.target.getAttribute('data-task-id'));
                }
                if (e.target.classList.contains('item-complete')) {
                    toggleItemCompletion(e.target.getAttribute('data-item-id'));
                }
            });

            // Удаление задач
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-task')) {
                    const taskId = e.target.closest('.delete-task').getAttribute('data-task-id');
                    deleteTask(taskId);
                }
                if (e.target.closest('.delete-item')) {
                    const itemId = e.target.closest('.delete-item').getAttribute('data-item-id');
                    deleteChecklistItem(itemId);
                }
                if (e.target.closest('.apply-template')) {
                    const templateId = e.target.closest('.apply-template').getAttribute('data-template-id');
                    applyTemplate(templateId);
                }
            });
        }

        // Фильтрация элементов
        function filterItems(type, filter) {
            const items = document.querySelectorAll(`.${type}-item`);

            items.forEach(item => {
                const isCreator = item.getAttribute('data-creator') === currentUsername;
                const isAssigned = item.getAttribute('data-assigned-user') === currentUserId.toString();
                const isCompleted = item.classList.contains('completed');

                let show = false;

                switch (filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'my':
                        show = isCreator || isAssigned;
                        break;
                    case 'active':
                        show = !isCompleted;
                        break;
                }

                item.style.display = show ? 'flex' : 'none';
            });

            // Обновление активной кнопки фильтра
            document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
            });
        }

        // Функции для работы с задачами
        async function addTask() {
            const form = document.getElementById('taskForm');
            const description = form.querySelector('[name="description"]').value.trim();
            const assignedUserId = form.querySelector('[name="assignedUserId"]').value;

            if (!description) {
                alert('Введите описание задачи');
                return;
            }

            try {
                const response = await fetch('/api/v1/task?eventId=' + eventId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        description: description,
                        assignedUserId: assignedUserId || null
                    })
                });

                if (response.ok) {
                    $('#addTaskModal').modal('hide');
                    form.reset();
                    await loadTasks();
                    alert('Задача успешно добавлена!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create task');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Ошибка при создании задачи: ' + error.message);
            }
        }

        async function toggleTaskCompletion(taskId) {
            try {
                await fetch('/api/v1/task/' + taskId + '/toggle', {
                    method: 'PATCH',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    }
                });
                await loadTasks();
            } catch (error) {
                console.error('Error toggling task:', error);
                alert('Ошибка при обновлении задачи');
            }
        }

        async function deleteTask(taskId) {
            if (confirm('Удалить задачу?')) {
                try {
                    await fetch('/api/v1/task/' + taskId, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        }
                    });
                    await loadTasks();
                    alert('Задача удалена!');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Ошибка при удалении задачи');
                }
            }
        }

        // Функции для работы со списком вещей
        async function addChecklistItem() {
            const form = document.getElementById('checklistForm');
            const name = form.querySelector('[name="name"]').value.trim();
            const description = form.querySelector('[name="description"]').value.trim();
            const quantity = form.querySelector('[name="quantity"]').value;
            const assignedUserId = form.querySelector('[name="assignedUserId"]').value;

            if (!name) {
                alert('Введите название элемента');
                return;
            }

            try {
                const response = await fetch('/api/v1/checklist?eventId=' + eventId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        quantity: parseInt(quantity) || 1,
                        assignedUserId: assignedUserId || null
                    })
                });

                if (response.ok) {
                    $('#addChecklistModal').modal('hide');
                    form.reset();
                    await loadChecklist();
                    alert('Элемент успешно добавлен!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create checklist item');
                }
            } catch (error) {
                console.error('Error adding checklist item:', error);
                alert('Ошибка при добавлении элемента: ' + error.message);
            }
        }

        async function toggleItemCompletion(itemId) {
            try {
                await fetch('/api/v1/checklist/' + itemId + '/toggle', {
                    method: 'PATCH',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    }
                });
                await loadChecklist();
            } catch (error) {
                console.error('Error toggling item:', error);
                alert('Ошибка при обновлении элемента');
            }
        }

        async function deleteChecklistItem(itemId) {
            if (confirm('Удалить элемент из списка?')) {
                try {
                    await fetch('/api/v1/checklist/' + itemId, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        }
                    });
                    await loadChecklist();
                    alert('Элемент удален!');
                } catch (error) {
                    console.error('Error deleting item:', error);
                    alert('Ошибка при удалении элемента');
                }
            }
        }

        async function applyTemplate(templateId) {
            if (!confirm('Применить этот шаблон? Все существующие элементы списка будут сохранены.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/public/templates/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        eventId: eventId
                    })
                });

                if (response.ok) {
                    $('#templatesModal').modal('hide');
                    await loadChecklist();
                    alert('Шаблон успешно применен!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to apply template');
                }
            } catch (error) {
                console.error('Error applying template:', error);
                alert('Ошибка при применении шаблона: ' + error.message);
            }
        }
    </script>
</div>
</body>
</html>