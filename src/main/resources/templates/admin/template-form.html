<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title th:text="${template.id != null} ? 'Редактирование шаблона' : 'Создание шаблона'">Создание шаблона</title>
    <style>
        .template-form-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .item-row {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-clipboard-list me-2 text-warning"></i>
                    <span th:text="${templateId != null} ? 'Редактирование шаблона' : 'Создание шаблона'">
                        Создание шаблона
                    </span>
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Админ-панель</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/admin/templates}">Шаблоны</a></li>
                        <li class="breadcrumb-item active" th:text="${template.id != null} ? 'Редактирование' : 'Создание'"></li>
                    </ol>
                </nav>
            </div>
            <a th:href="@{/admin/templates}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Назад
            </a>
        </div>

        <!-- Сообщения -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card template-form-card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>Информация о шаблоне
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form th:action="${templateId != null} ?
      @{/admin/templates/{id}/edit(id=${templateId})} :
      @{/admin/templates/create}"
                              method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="name" class="form-label">Название шаблона *</label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           th:value="${templateRequest.name}" required
                                           placeholder="Например: Пикник на природе">
                                </div>
                                <div class="col-md-4">
                                    <label for="category" class="form-label">Категория *</label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Выберите категорию</option>
                                        <option th:each="cat : ${categories}"
                                                th:value="${cat}"
                                                th:text="${cat}"
                                                th:selected="${templateRequest.category == cat}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">Описание</label>
                                <textarea class="form-control" id="description" name="description"
                                          rows="3" placeholder="Описание шаблона..."
                                          th:text="${templateRequest.description}"></textarea>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Элементы шаблона</h5>
                                <button type="button" class="btn btn-primary btn-sm" id="addItemBtn">
                                    <i class="fas fa-plus me-1"></i>Добавить элемент
                                </button>
                            </div>

                            <div id="itemsContainer">
                                <!-- Элементы будут добавляться здесь -->
                                <div th:each="item, stat : ${templateRequest.items}" class="item-row">
                                    <input type="hidden" th:name="items[__${stat.index}__].name" th:value="${item.name}" />
                                    <input type="hidden" th:name="items[__${stat.index}__].description" th:value="${item.description}" />
                                    <input type="hidden" th:name="items[__${stat.index}__].defaultQuantity" th:value="${item.defaultQuantity}" />

                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Название элемента</label>
                                            <input type="text" class="form-control item-name"
                                                   th:value="${item.name}" required
                                                   placeholder="Например: Плед"
                                                   onchange="updateHiddenField(this)">
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">Описание</label>
                                            <input type="text" class="form-control item-description"
                                                   th:value="${item.description}"
                                                   placeholder="Описание элемента"
                                                   onchange="updateHiddenField(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Кол-во</label>
                                            <input type="number" class="form-control item-quantity"
                                                   th:value="${item.defaultQuantity}" min="1" value="1"
                                                   onchange="updateHiddenField(this)">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-item">
                                            <i class="fas fa-trash"></i> Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-warning w-100 py-2">
                                    <i class="fas fa-save me-2"></i>
                                    <span th:text="${templateId != null} ? 'Сохранить изменения' : 'Создать шаблон'">
                Создать шаблон
            </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let itemCount = document.querySelectorAll('.item-row').length;

            // Функция для обновления скрытых полей
            window.updateHiddenField = function(input) {
                const row = input.closest('.item-row');
                const index = Array.from(row.parentNode.children).indexOf(row);

                if (input.classList.contains('item-name')) {
                    row.querySelector('input[name="items[' + index + '].name"]').value = input.value;
                } else if (input.classList.contains('item-description')) {
                    row.querySelector('input[name="items[' + index + '].description"]').value = input.value;
                } else if (input.classList.contains('item-quantity')) {
                    row.querySelector('input[name="items[' + index + '].defaultQuantity"]').value = input.value;
                }
            };

            // Добавление нового элемента
            document.getElementById('addItemBtn').addEventListener('click', function() {
                const container = document.getElementById('itemsContainer');
                const newItem = document.createElement('div');
                newItem.className = 'item-row';
                newItem.innerHTML = `
            <input type="hidden" name="items[${itemCount}].name" value="">
            <input type="hidden" name="items[${itemCount}].description" value="">
            <input type="hidden" name="items[${itemCount}].defaultQuantity" value="1">

            <div class="row">
                <div class="col-md-5">
                    <label class="form-label">Название элемента</label>
                    <input type="text" class="form-control item-name" required
                           placeholder="Например: Плед"
                           onchange="updateHiddenField(this)">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Описание</label>
                    <input type="text" class="form-control item-description"
                           placeholder="Описание элемента"
                           onchange="updateHiddenField(this)">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Кол-во</label>
                    <input type="number" class="form-control item-quantity"
                           min="1" value="1"
                           onchange="updateHiddenField(this)">
                </div>
            </div>
            <div class="mt-2 text-end">
                <button type="button" class="btn btn-danger btn-sm remove-item">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            </div>
        `;
                container.appendChild(newItem);
                itemCount++;
            });

            // Удаление элемента
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    const row = e.target.closest('.item-row');
                    row.remove();
                    // Переиндексируем оставшиеся элементы
                    reindexItems();
                }
            });

            function reindexItems() {
                const rows = document.querySelectorAll('.item-row');
                rows.forEach((row, index) => {
                    // Обновляем имена скрытых полей
                    const nameInput = row.querySelector('input[type="hidden"]:nth-child(1)');
                    const descInput = row.querySelector('input[type="hidden"]:nth-child(2)');
                    const quantInput = row.querySelector('input[type="hidden"]:nth-child(3)');

                    nameInput.name = `items[${index}].name`;
                    descInput.name = `items[${index}].description`;
                    quantInput.name = `items[${index}].defaultQuantity`;
                });
                itemCount = rows.length;
            }

            // Валидация формы
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const visibleInputs = document.querySelectorAll('.item-name');
                let hasErrors = false;

                visibleInputs.forEach(input => {
                    if (!input.value.trim()) {
                        hasErrors = true;
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });

                if (hasErrors) {
                    e.preventDefault();
                    alert('Заполните названия всех элементов');
                }
            });
        });
    </script>
</div>
</body>
</html>